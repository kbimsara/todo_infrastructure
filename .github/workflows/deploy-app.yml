name: Deploy App Updates

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'docker-compose.yml'
      - 'Dockerfile'

jobs:
  deploy-update:
    name: 'Deploy Application Updates'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      
      - name: Check if VM exists
        id: check_vm
        run: |
          if gcloud compute instances describe todo-app-vm --zone=us-central1-a &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "VM exists - will update application"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "VM does not exist - please run infrastructure deployment first"
            exit 1
          fi
      
      - name: Pull Latest Code on VM
        run: |
          echo "Pulling latest code from repository..."
          gcloud compute ssh todo-app-vm --zone=us-central1-a --command="
            set -e
            cd /home/ubuntu/app/Deployee || exit 1
            
            echo 'Pulling latest changes...'
            sudo git fetch origin
            sudo git reset --hard origin/main
            sudo git pull origin main
            
            echo 'Current commit:'
            git log -1 --oneline
          " || {
            echo "Failed to pull code. VM might not be ready yet."
            exit 1
          }
      
      - name: Rebuild and Restart Application
        run: |
          echo "Rebuilding and restarting application..."
          gcloud compute ssh todo-app-vm --zone=us-central1-a --command="
            set -e
            cd /home/ubuntu/app/Deployee
            
            echo 'Stopping existing containers...'
            sudo docker-compose down || true
            
            echo 'Removing old images...'
            sudo docker-compose rm -f || true
            sudo docker system prune -f || true
            
            echo 'Building new images (no cache)...'
            sudo docker-compose build --no-cache
            
            echo 'Starting containers...'
            sudo docker-compose up -d
            
            echo 'Waiting for application to start...'
            sleep 10
            
            echo 'Container status:'
            sudo docker-compose ps
            
            echo 'Recent logs:'
            sudo docker-compose logs --tail=50
          " || {
            echo "Failed to rebuild application"
            exit 1
          }
      
      - name: Verify Deployment
        id: verify
        run: |
          echo "Verifying deployment..."
          
          # Get VM IP
          VM_IP=$(gcloud compute instances describe todo-app-vm \
            --zone=us-central1-a \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          
          echo "vm_ip=${VM_IP}" >> $GITHUB_OUTPUT
          
          # Wait for app to be ready
          echo "Waiting for application to respond..."
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            if curl -f -s -m 5 "http://${VM_IP}:3000" > /dev/null 2>&1; then
              echo "Application is responding!"
              echo "success=true" >> $GITHUB_OUTPUT
              break
            fi
            
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts - waiting..."
            sleep 10
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "Application did not respond in time"
            echo "success=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Get Application Logs
        if: steps.verify.outputs.success != 'true'
        run: |
          echo "Fetching application logs for debugging..."
          gcloud compute ssh todo-app-vm --zone=us-central1-a --command="
            cd /home/ubuntu/app/Deployee
            echo '=== Docker Status ==='
            sudo docker-compose ps
            echo ''
            echo '=== Application Logs ==='
            sudo docker-compose logs --tail=100
          " || echo "Could not fetch logs"
        continue-on-error: true
      
      - name: Display Results
        run: |
          echo "## Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.verify.outputs.success }}" == "true" ]; then
            echo "### ✅ Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Application updated and verified!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Access your application:**" >> $GITHUB_STEP_SUMMARY
            echo "- Direct: \`http://${{ steps.verify.outputs.vm_ip }}:3000\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ⚠️ Deployment Issues" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The application was deployed but may not be responding correctly." >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Useful Commands" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# View live logs" >> $GITHUB_STEP_SUMMARY
          echo "gcloud compute ssh todo-app-vm --zone=us-central1-a --command='cd /home/ubuntu/app/Deployee && sudo docker-compose logs -f'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check container status" >> $GITHUB_STEP_SUMMARY
          echo "gcloud compute ssh todo-app-vm --zone=us-central1-a --command='sudo docker ps'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Restart application" >> $GITHUB_STEP_SUMMARY
          echo "gcloud compute ssh todo-app-vm --zone=us-central1-a --command='cd /home/ubuntu/app/Deployee && sudo docker-compose restart'" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Console output
          echo "=========================================="
          echo "DEPLOYMENT COMPLETE"
          echo "=========================================="
          if [ "${{ steps.verify.outputs.success }}" == "true" ]; then
            echo "✅ Application updated successfully"
            echo "Access: http://${{ steps.verify.outputs.vm_ip }}:3000"
          else
            echo "⚠️  Deployment completed but verification failed"
            echo "Check logs for details"
          fi