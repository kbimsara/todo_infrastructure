# .github/workflows/terraform-deploy.yml
# Auto-detects infrastructure changes and applies them

name: Deploy Infrastructure to GCP

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'apply'
        type: choice
        options:
          - apply
          - destroy
          - clean-apply
          - plan-only

env:
  TF_VERSION: '1.6.0'

jobs:
  terraform:
    name: 'Terraform Deploy'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Create terraform.tfvars
        working-directory: ./infrastructure
        run: |
          cat > terraform.tfvars <<EOF
          project_id  = "${{ secrets.GCP_PROJECT_ID }}"
          region      = "us-central1"
          zone        = "us-central1-a"
          github_repo = "https://github.com/${{ github.repository }}.git"
          EOF
      
      - name: Terraform Init
        working-directory: ./infrastructure
        run: terraform init
      
      # Clean up if 'clean-apply' is selected
      - name: Clean Up Existing Resources
        if: github.event.inputs.action == 'clean-apply'
        working-directory: ./infrastructure
        run: |
          echo " Cleaning up existing resources..."
          
          # Try to destroy via Terraform first
          terraform destroy -auto-approve || true
          
          # Wait a bit for resources to be released
          sleep 10
          
          # Manually delete any remaining resources IN CORRECT ORDER
          echo "Deleting forwarding rule..."
          gcloud compute forwarding-rules delete todo-app-http-forwarding-rule --global --quiet 2>/dev/null || true
          
          echo "Deleting HTTP proxy..."
          gcloud compute target-http-proxies delete todo-app-http-proxy --quiet 2>/dev/null || true
          
          echo "Deleting URL map..."
          gcloud compute url-maps delete todo-app-load-balancer --quiet 2>/dev/null || true
          
          echo "Deleting backend service..."
          gcloud compute backend-services delete todo-app-backend --global --quiet 2>/dev/null || true
          
          echo "Deleting instance group..."
          gcloud compute instance-groups unmanaged delete todo-app-instance-group --zone=us-central1-a --quiet 2>/dev/null || true
          
          echo "Deleting VM..."
          gcloud compute instances delete todo-app-vm --zone=us-central1-a --quiet 2>/dev/null || true
          
          echo "Deleting health check..."
          gcloud compute health-checks delete todo-app-health-check --quiet 2>/dev/null || true
          
          echo "Deleting firewall rules..."
          gcloud compute firewall-rules delete allow-http --quiet 2>/dev/null || true
          gcloud compute firewall-rules delete allow-https --quiet 2>/dev/null || true
          gcloud compute firewall-rules delete allow-health-check --quiet 2>/dev/null || true
          gcloud compute firewall-rules delete allow-ssh-todo --quiet 2>/dev/null || true
          gcloud compute firewall-rules delete allow-app-port-3000 --quiet 2>/dev/null || true
          
          echo "Deleting static IP..."
          gcloud compute addresses delete todo-app-static-ip --global --quiet 2>/dev/null || true
          
          # Remove terraform state to start fresh
          rm -f terraform.tfstate terraform.tfstate.backup .terraform.lock.hcl
          rm -rf .terraform
          
          # Re-initialize
          terraform init
          
          echo "Cleanup complete"
      
      # Import existing resources for regular apply
      - name: Smart Import of Existing Resources
        if: github.event.inputs.action == 'apply'
        working-directory: ./infrastructure
        run: |
          echo "Checking for existing resources to import..."
          
          # Function to attempt import
          import_resource() {
            local resource_type=$1
            local resource_name=$2
            local gcp_name=$3
            
            # Check if already in state
            if terraform state list | grep -q "$resource_type.$resource_name"; then
              echo "  ✓ $resource_name already in state"
              return 0
            fi
            
            # Try to import
            if terraform import "$resource_type.$resource_name" "$gcp_name" 2>/dev/null; then
              echo "  ✓ Imported $resource_name"
            else
              echo "  • $resource_name doesn't exist or already managed"
            fi
          }
          
          # Import firewall rules
          import_resource "google_compute_firewall" "allow_http" "allow-http"
          import_resource "google_compute_firewall" "allow_https" "allow-https"
          import_resource "google_compute_firewall" "allow_health_check" "allow-health-check"
          import_resource "google_compute_firewall" "allow_ssh" "allow-ssh-todo"
          import_resource "google_compute_firewall" "allow_app_port" "allow-app-port-3000"
          
          # Import networking
          import_resource "google_compute_global_address" "nextjs_ip" "todo-app-static-ip"
          import_resource "google_compute_health_check" "nextjs_health_check" "todo-app-health-check"
          
          # Import compute resources
          import_resource "google_compute_instance" "nextjs_vm" "us-central1-a/todo-app-vm"
          import_resource "google_compute_instance_group" "nextjs_ig" "us-central1-a/todo-app-instance-group"
          
          # Import load balancer components
          import_resource "google_compute_backend_service" "nextjs_backend" "todo-app-backend"
          import_resource "google_compute_url_map" "nextjs_lb" "todo-app-load-balancer"
          import_resource "google_compute_target_http_proxy" "nextjs_http_proxy" "todo-app-http-proxy"
          import_resource "google_compute_global_forwarding_rule" "nextjs_http_rule" "todo-app-http-forwarding-rule"
          
          echo "Import check complete"
        continue-on-error: true
      
      - name: Terraform Plan
        id: plan
        working-directory: ./infrastructure
        run: |
          echo "Planning infrastructure changes..."
          terraform plan -detailed-exitcode -out=tfplan || exit_code=$?
          
          # Exit codes: 0 = no changes, 1 = error, 2 = changes present
          if [ "${exit_code}" == "1" ]; then
            echo "Planning failed"
            exit 1
          elif [ "${exit_code}" == "2" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected - will apply"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No infrastructure changes needed"
          fi
        continue-on-error: false
      
      - name: Show Plan Summary
        if: steps.plan.outputs.changes == 'true'
        working-directory: ./infrastructure
        run: |
          echo "## Infrastructure Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following changes will be applied:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          terraform show tfplan >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: Terraform Apply
        if: |
          (github.event.inputs.action == 'apply' && steps.plan.outputs.changes == 'true') || 
          github.event.inputs.action == 'clean-apply'
        working-directory: ./infrastructure
        run: |
          echo "Applying infrastructure changes..."
          terraform apply -auto-approve tfplan
          echo "Apply complete"
      
      - name: No Changes Needed
        if: github.event.inputs.action == 'apply' && steps.plan.outputs.changes == 'false'
        run: |
          echo "## No Changes Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your infrastructure is already up to date with the configuration." >> $GITHUB_STEP_SUMMARY
          echo "No changes were applied." >> $GITHUB_STEP_SUMMARY
      
      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        working-directory: ./infrastructure
        run: |
          echo "Destroying infrastructure..."
          terraform destroy -auto-approve
          echo "Destroy complete"
      
      - name: Plan Only (No Apply)
        if: github.event.inputs.action == 'plan-only'
        working-directory: ./infrastructure
        run: |
          echo "## Plan Only - No Changes Applied" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This was a plan-only run. No infrastructure changes were made." >> $GITHUB_STEP_SUMMARY
      
      - name: Get Outputs
        if: github.event.inputs.action == 'apply' || github.event.inputs.action == 'clean-apply'
        id: outputs
        working-directory: ./infrastructure
        run: |
          echo "vm_ip=$(terraform output -raw vm_external_ip 2>/dev/null || echo 'pending')" >> $GITHUB_OUTPUT
          echo "lb_ip=$(terraform output -raw load_balancer_ip 2>/dev/null || echo 'pending')" >> $GITHUB_OUTPUT
          echo "direct_url=$(terraform output -raw direct_vm_url 2>/dev/null || echo 'pending')" >> $GITHUB_OUTPUT
      
      - name: Display Results
        if: github.event.inputs.action == 'apply' || github.event.inputs.action == 'clean-apply'
        run: |
          echo "## Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.plan.outputs.changes }}" == "true" ] || [ "${{ github.event.inputs.action }}" == "clean-apply" ]; then
            echo "### Infrastructure Updated Successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Infrastructure Already Up to Date" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Access Your Application" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Direct VM Access (Works NOW):**" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.outputs.outputs.direct_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Load Balancer (Wait 5-10 minutes):**" >> $GITHUB_STEP_SUMMARY
          echo "http://${{ steps.outputs.outputs.lb_ip }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Commands" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# SSH to VM" >> $GITHUB_STEP_SUMMARY
          echo "gcloud compute ssh todo-app-vm --zone=us-central1-a" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check containers" >> $GITHUB_STEP_SUMMARY
          echo "sudo docker ps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View logs" >> $GITHUB_STEP_SUMMARY
          echo "cd /home/ubuntu/app && sudo docker-compose logs -f" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "=========================================="
          echo "DEPLOYMENT COMPLETE!"
          echo "=========================================="
          echo ""
          echo "Direct Access: ${{ steps.outputs.outputs.direct_url }}"
          echo "Load Balancer: http://${{ steps.outputs.outputs.lb_ip }}"
          echo ""
          if [ "${{ steps.plan.outputs.changes }}" == "true" ] || [ "${{ github.event.inputs.action }}" == "clean-apply" ]; then
            echo "Infrastructure changes applied successfully!"
          else
            echo "No infrastructure changes were needed"
          fi
      
      - name: Check Backend Health
        if: |
          (github.event.inputs.action == 'apply' && steps.plan.outputs.changes == 'true') || 
          github.event.inputs.action == 'clean-apply'
        run: |
          echo "Waiting 30 seconds before checking backend health..."
          sleep 30
          gcloud compute backend-services get-health todo-app-backend --global || echo "Backend not ready yet (this is normal, wait 10 minutes)"
        continue-on-error: true