name: GCP Infrastructure Cleanup

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type DELETE to confirm cleanup"
        required: true
        default: ""

jobs:
  cleanup:
    if: github.event.inputs.confirm == 'DELETE'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: my-app-todo-485623

      - name: Delete Compute Engine resources
        run: |
          set +e

          echo "Deleting VM..."
          gcloud compute instances delete todo-app-vm \
            --zone=us-central1-a --quiet || true

          echo "Deleting instance group..."
          gcloud compute instance-groups unmanaged delete todo-app-instance-group \
            --zone=us-central1-a --quiet || true

          echo "Deleting firewall rules..."
          gcloud compute firewall-rules delete \
            allow-http \
            allow-https \
            allow-ssh-todo \
            allow-health-check \
            allow-app-port-3000 \
            --quiet || true

          echo "Deleting health check..."
          gcloud compute health-checks delete todo-app-health-check \
            --quiet || true

          echo "Deleting backend service..."
          gcloud compute backend-services delete todo-app-backend \
            --global --quiet || true

          echo "Deleting URL map..."
          gcloud compute url-maps delete todo-app-load-balancer \
            --quiet || true

          echo "Deleting HTTP proxy..."
          gcloud compute target-http-proxies delete todo-app-http-proxy \
            --quiet || true

          echo "Deleting forwarding rule..."
          gcloud compute forwarding-rules delete todo-app-http-forwarding-rule \
            --global --quiet || true

          echo "Deleting static IP..."
          gcloud compute addresses delete todo-app-static-ip \
            --global --quiet || true

          echo "GCP cleanup completed"
